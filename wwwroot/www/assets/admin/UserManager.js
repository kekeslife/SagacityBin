import{$ as _}from"../axiosExt.js";import{u as le}from"../storage.js";import{v as D,E as R}from"../lang.js";import{E as B}from"../util.js";import{s as U,a as te,b as oe,v as re}from"../KaUpload.js";import{d as ne,h as ie,r as h,p as ce,n as ue,c as de,w as t,b as M,j as v,o as me,f as s,u as i,l as g,t as w}from"../vendor.js";import{_ as pe}from"../Home.js";import"../pinia.js";import"../json-data.js";import"../ant-design-vue.js";const ve=ne({__name:"UserManager",setup(fe){const{lang:r}=M("lang"),k=M("loading"),N=le(),o=ie({account:null,userId:0,userName:null,password:null,mailAddress:void 0,state:null}),P=[{required:!0,validator:ee}],z=h(),C=h(),x=h([]),A=h([]),E=h([]),I=h([]),y=h([]),b=h([]),L=async(e,a)=>{if(a.isNew){F(),o.userName=a.value;return}k.value=!0;try{const l=_.get("/api/adminUser/user/"+e),n=_.get("/api/adminUser/userRoles/"+e),d=_.get("/api/adminUser/userPrograms/"+e),u=await Promise.all([l,n,d]),f=u[0].data,c=u[1].data,S=u[2].data;if(!f.isSuccess)throw f.message;if(!c.isSuccess)throw c.message;if(!S.isSuccess)throw S.message;Y(f.record,c.records.map(m=>({label:m.roleDesc,value:m.roleNo})),S.records.map(m=>({label:N.lang===R.chinese?m.programDesc:m.programDescEn??m.programDesc,value:m.programId})))}catch(l){U(l)}finally{k.value=!1}},V=async e=>{if(!await new Promise((c,S)=>{te(c,r.value.validate.是否覆盖数据)}))return;const l=_.get("/api/adminUser/userRoles/"+e),n=_.get("/api/adminUser/userPrograms/"+e),d=await Promise.all([l,n]),u=d[0].data,f=d[1].data;if(!u.isSuccess)throw u.message;if(!f.isSuccess)throw f.message;b.value=u.records.map(c=>({label:c.roleDesc,value:c.roleNo})),y.value=f.records.map(c=>({label:N.lang===R.chinese?c.programDesc:c.programDescEn??c.programDesc,value:c.programId}))},T=async()=>{var e;try{await((e=C.value)==null?void 0:e.validate().catch(n=>{if(n.errorFields&&n.errorFields.length)throw n.errorFields[0].errors[0]}));const l=(await _.post("/api/adminUser/user",{user:{userId:o.userId,userName:o.userName,mailAddress:o.mailAddress,password:o.password,state:o.state},programs:y.value.map(n=>n.value),roles:b.value.map(n=>n.value)})).data;if(l.isSuccess)oe(r.value.util.保存成功),F(!0);else throw l.message}catch(a){U(a)}},F=(e=!1)=>{o.password=null,o.mailAddress=void 0,o.state=null,o.userName=null,o.userId=0,y.value=[],b.value=[],e&&(o.account=null)},Y=(e,a,l)=>{o.password=e.password,o.mailAddress=e.mailAddress,o.state=e.state,o.userName=e.userName,o.userId=e.userId,y.value=l,b.value=a},G=(e,a)=>{y.value.some(l=>l.value===e)||y.value.push(a)},H=(e,a)=>{b.value.some(l=>l.value===e)||b.value.push(a)},J=e=>{b.value.splice(e,1)},K=e=>{y.value.splice(e,1)},O=ce(async(e,a)=>{if(!e)return;const n=(await _.get("/api/adminUser/searchUsers/"+e)).data;if(n.isSuccess){const d=n.records.map(u=>({label:u.userName,value:u.userId}));d.push({label:D.合并("["+r.value.util.新增+"]",e),value:e,isNew:!0}),a==="user"?E.value=d:I.value=d}else U(n.message)},300),Q=async e=>{e instanceof Event&&(e=e.target.value),O(e,"user")},W=async e=>{e instanceof Event&&(e=e.target.value),O(e,"copy")},X=async()=>{const a=(await _.get("/api/adminProgram/programs")).data;a.isSuccess?x.value=a.records.map(l=>({label:N.lang===R.chinese?l.programDesc:l.programDescEn??l.programDesc,value:l.programId})):U(r.value.validate.初始化选项失败)},Z=async()=>{const a=(await _.get("/api/adminRole/roles")).data;a.isSuccess?A.value=a.records.map(l=>({label:l.roleDesc,value:l.roleNo})):U(r.value.validate.初始化选项失败)};async function ee(e,a){return re(r.value.validate,a)}return ue(async()=>{X(),Z()}),(e,a)=>{const l=v("a-select"),n=v("a-form-item"),d=v("a-input"),u=v("a-select-option"),f=v("a-divider"),c=v("a-button"),S=v("a-form"),m=v("a-card"),j=v("a-list-item"),q=v("a-list"),ae=v("a-flex");return me(),de(ae,{gap:"large"},{default:t(()=>[s(m,null,{default:t(()=>[s(S,{ref_key:"$form",ref:C,layout:"vertical",model:o},{default:t(()=>[s(n,{rules:P,name:"account",class:"item",label:`${i(r).admin.用户编号} / ${i(r).admin.用户名}`},{default:t(()=>[s(l,{"show-search":"",options:E.value,onSearch:Q,onSelect:L,value:o.account,"onUpdate:value":a[0]||(a[0]=p=>o.account=p)},null,8,["options","value"])]),_:1},8,["label"]),s(n,{rules:P,name:"password",class:"item",label:`${i(r).admin.密码}`},{default:t(()=>[s(d,{value:o.password,"onUpdate:value":a[1]||(a[1]=p=>o.password=p)},null,8,["value"])]),_:1},8,["label"]),s(n,{name:"mailAddress",class:"item",label:`${i(r).admin.邮箱}`},{default:t(()=>[s(d,{value:o.mailAddress,"onUpdate:value":a[2]||(a[2]=p=>o.mailAddress=p)},null,8,["value"])]),_:1},8,["label"]),s(n,{rules:P,name:"state",class:"item",label:`${i(r).util.状态}`},{default:t(()=>[s(l,{value:o.state,"onUpdate:value":a[3]||(a[3]=p=>o.state=p)},{default:t(()=>[s(u,{value:i(B).Y},{default:t(()=>[g(w(i(r).util.启用),1)]),_:1},8,["value"]),s(u,{value:i(B).N},{default:t(()=>[g(w(i(r).util.停用),1)]),_:1},8,["value"])]),_:1},8,["value"])]),_:1},8,["label"]),s(f),s(n,{class:"item",label:`${i(D).合并(i(r).util.新增,i(r).admin.个人程序)}`},{default:t(()=>[s(l,{ref_key:"$password",ref:z,value:"","show-search":"",onSelect:G,options:x.value},null,8,["options"])]),_:1},8,["label"]),s(n,{class:"item",label:`${i(D).合并(i(r).util.新增,i(r).admin.权限组)}`},{default:t(()=>[s(l,{value:"","show-search":"",onSelect:H,options:A.value},null,8,["options"])]),_:1},8,["label"]),s(n,{class:"item",label:i(r).admin.复制用户},{default:t(()=>[s(l,{"show-search":"",options:I.value,onSearch:W,onSelect:V,value:""},null,8,["options"])]),_:1},8,["label"]),s(n,null,{default:t(()=>[s(c,{type:"primary",onClick:T},{default:t(()=>[g(w(i(r).util.保存),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),s(m,{title:i(r).admin.权限组,style:{flex:"1 0"},bodyStyle:{padding:0}},{extra:t(()=>[s(c,{type:"link"},{default:t(()=>[g(w(i(r).util.清空),1)]),_:1})]),default:t(()=>[s(q,{"data-source":b.value,size:"small"},{renderItem:t(({item:p,index:$})=>[s(j,null,{actions:t(()=>[s(c,{type:"link",onClick:se=>J($)},{default:t(()=>[g(w(i(r).util.删除),1)]),_:2},1032,["onClick"])]),default:t(()=>[g(" "+w(p.label),1)]),_:2},1024)]),_:1},8,["data-source"])]),_:1},8,["title"]),s(m,{title:i(r).admin.个人程序,bodyStyle:{padding:0},style:{flex:"1 0"}},{extra:t(()=>[s(c,{type:"link"},{default:t(()=>[g(w(i(r).util.清空),1)]),_:1})]),default:t(()=>[s(q,{size:"small","data-source":y.value},{renderItem:t(({item:p,index:$})=>[s(j,null,{actions:t(()=>[s(c,{type:"link",onClick:se=>K($)},{default:t(()=>[g(w(i(r).util.删除),1)]),_:2},1032,["onClick"])]),default:t(()=>[g(" "+w(p.label),1)]),_:2},1024)]),_:1},8,["data-source"])]),_:1},8,["title"])]),_:1})}}}),$e=pe(ve,[["__scopeId","data-v-f578e218"]]);export{$e as default};
