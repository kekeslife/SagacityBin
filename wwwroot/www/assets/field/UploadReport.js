import{d as C,E as u,r as m,c as I,w as K,b as v,j as R,o as P,f as _,u as h,k as U,v as j}from"../vendor.js";import{K as A}from"../ka-table.js";import{K as E,s as g}from"../KaUpload.js";import{$ as y}from"../axiosExt.js";import"../ant-design-vue.js";import"../Home.js";import"../pinia.js";import"../storage.js";import"../lang.js";import"../json-data.js";const J=C({__name:"UploadReport",setup(T){const{lang:c}=v("lang"),f=v("loading"),o=u(""),r=u("");let i=!1;const w={hasExport:!1,hasRemove:!1,hasEdit:!1,hasAdd:!1},x={snKey:{title:"SN",dbInfo:{isPk:!0},listInfo:{index:1,width:"150px"},sortInfo:{index:null}},modifyAt:{title:c.value.util.修改时间,listInfo:{index:7},dbInfo:{dataType:"date"},sortInfo:{index:null}}},b=m(),l=m([]),k=async a=>{var n;f.value=!0;const e=(n=a.curRecord)==null?void 0:n.snKey;o.value=e;try{const s=(await y.post("/api/fieldPic/pics/",e,{headers:{"Content-Type":"application/json"}})).data;if(s.isSuccess)r.value=s.message,s.records?l.value=s.records.map(d=>({uid:d,name:d,url:`/files/field/${s.message}/${d}`,state:"done"})):l.value=[];else throw s.message}catch(t){g(t)}finally{f.value=!1}return{isSuccess:!0}},$=(a,e)=>{i||(i=!0,p())},S=(a,e)=>{i||(i=!0,p())},p=async()=>{if(o.value)try{const e=(await y.post("/api/fieldPic/log",o.value,{headers:{"Content-Type":"application/json"}})).data;if(!e.isSuccess)throw e.message}catch(a){g(a)}};return(a,e)=>{const n=R("a-flex");return P(),I(n,{gap:"middle"},{default:K(()=>[_(h(A),{ref_key:"$table",ref:b,"table-title":h(c).field.外勤,size:"small",columns:x,toolbar:w,url:"/api/fieldpic/table","on-after-row-click":k,"init-sorter-conditions":[{key:"modifyAt",index:1,order:"descend"}],"is-debug":!1},null,8,["table-title"]),U(_(E,{"file-list":l.value,"onUpdate:fileList":e[0]||(e[0]=t=>l.value=t),action:"/api/fieldpic/upload",data:{sn:r.value},"remove-data":t=>`${r.value}/${t.name}`,"remove-url":"/api/fieldpic/del",onPostRemove:S,onPostUpload:$},null,8,["file-list","data","remove-data"]),[[j,!!o.value]])]),_:1})}}});export{J as default};
