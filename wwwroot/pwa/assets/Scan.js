import{d as W,m as j,u as q,w as G,s as v,t as J,A as K,B as P,C as Q,n as g,v as y,c as R,b as B,i as X,r as _,o as S,k as D,h as Y,l as ee,F as ae,e as f,E as te,D as oe}from"./vendor.js";import{_ as se}from"./KVUpload.js";const le={class:"position-fixed h-100 w-100"},ne=W({__name:"Scan",props:j({isSelect:{type:Boolean,default:!1},options:{type:Object}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:j(["change"],["update:modelValue"]),setup(k,{emit:T}){const{showError:z}=X("alert"),p=q(k,"modelValue"),M=T,w=k;G(p,async e=>{e?(await L(),await V()):Z()});const i=v(!1),h=v(!1);let c,x;const b=v([]),u=v([]),r=v(-1);let n=null;const o=J({hasZoom:!1,maxZoom:10,minZoom:1,zoom:1,hasTorch:!1});let C={formats:["Code128"],maxNumberOfSymbols:1,tryRotate:!1,tryInvert:!1,tryHarder:!0,minLineCount:2,characterSet:"ASCII"};const t=K(null),O=e=>{p.value=!1,M("change",e.text)},F=async()=>{h.value=!0,$(),await I()},I=async()=>{try{if(h.value){const e=await E();e!=null&&e.length&&(w.isSelect?(H(),b.value=e):O(e[0])),requestAnimationFrame(I)}}catch(e){throw e}},$=()=>{var e,a;c&&c.width===((e=t.value)==null?void 0:e.videoWidth)&&c.height===((a=t.value)==null?void 0:a.videoHeight)||(c=new OffscreenCanvas(t.value.videoWidth,t.value.videoHeight),x=c.getContext("2d"))},E=async()=>{try{x.drawImage(t.value,0,0);const e=x.getImageData(0,0,c.width,c.height);return await te(e,C)}catch(e){z(e)}},L=async()=>{if(u.value.length)return;await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}});const e=await navigator.mediaDevices.enumerateDevices();u.value=e==null?void 0:e.filter(a=>a.deviceId).map(a=>a.deviceId)},A=async()=>{u.value.length!==1&&(Z(),r.value>=u.value.length-1?r.value=0:r.value++,await V())},V=async()=>{var e,a;i.value=!1;try{r.value===-1&&(r.value=0);const s=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:u.value[r.value]}}});if(t.value.srcObject=s,t.value.play(),r.value=0,n=s.getVideoTracks()[0],n.getCapabilities&&n.getSettings){const m=n.getSettings(),d=n.getCapabilities();o.hasZoom=m.zoom!==void 0,o.maxZoom=((e=d.zoom)==null?void 0:e.max)||1,o.minZoom=((a=d.zoom)==null?void 0:a.min)||1,o.zoom=m.zoom||1,o.hasTorch=m.torch!==void 0}}catch(s){z(s)}},H=()=>{var e;(e=t.value)!=null&&e.srcObject&&(h.value=!1,t.value.pause()),i.value=!1},Z=()=>{var e;(e=t.value)!=null&&e.srcObject&&(h.value=!1,t.value.srcObject.getTracks().forEach(a=>a.stop()),t.value.srcObject=null),b.value=[],i.value=!1},N=()=>{i.value=!i.value,t.value.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:i.value}]})},U=e=>{o.hasZoom&&(n==null||n.applyConstraints({advanced:[{zoom:e}]}))};return P(()=>{w.options&&(C=Object.assign(C,w.options)),Q({locateFile:(e,a)=>e.endsWith(".wasm")?`/pwa/${e}`:a+e})}),(e,a)=>{const s=_("v-btn"),m=_("v-slider"),d=_("v-sheet");return g((S(),R(d,{class:"position-fixed top-0 bottom-0 ma-0 pa-0 w-100 h-100 bg-white",style:{"z-index":"2000"}},{default:B(()=>[D("video",{onLoadeddata:F,ref_key:"$video",ref:t,class:"position-fixed h-100 w-100"},null,544),D("div",le,[(S(!0),Y(ae,null,ee(b.value,l=>(S(),R(s,{style:oe({left:(l.position.topLeft.x+l.position.bottomRight.x)/2+"px",top:(l.position.topLeft.y+l.position.bottomRight.y)/2+"px"}),class:"position-absolute",key:l.symbologyIdentifier,icon:"far fa-circle-right",color:"success",onClick:ie=>O(l)},null,8,["style","onClick"]))),128))]),f(d,{class:"d-flex w-100 ga-2 position-absolute bottom-0 pa-4 bg-transparent"},{default:B(()=>[g(f(s,{onClick:N,icon:"fas fa-bolt",size:"small",color:i.value?"success":""},null,8,["color"]),[[y,o.hasTorch]]),g(f(s,{onClick:A,icon:"fas fa-rotate",size:"small"},null,512),[[y,u.value.length>1]]),f(s,{onClick:a[0]||(a[0]=l=>p.value=!1),size:"small",icon:"fas fa-xmark"}),g(f(m,{class:"flex-1-0",color:"white","hide-details":"",size:"small","onUpdate:modelValue":[U,a[1]||(a[1]=l=>o.zoom=l)],modelValue:o.zoom,min:o.minZoom,max:o.maxZoom,step:1},null,8,["modelValue","min","max"]),[[y,o.hasZoom]])]),_:1})]),_:1},512)),[[y,p.value]])}}}),ue=se(ne,[["__scopeId","data-v-4d3627ae"]]);export{ue as S};
