import{d as W,m as j,u as q,w as G,s as v,t as J,A as K,B as P,C as Q,n as g,v as y,c as R,b as B,i as X,r as _,o as S,k as D,h as Y,l as ee,F as ae,e as f,E as te,D as oe}from"./vendor.js";import{_ as se}from"./KVUpload.js";const ie={class:"position-fixed h-100 w-100"},le=W({__name:"Scan",props:j({isSelect:{type:Boolean,default:!1},options:{type:Object}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:j(["change"],["update:modelValue"]),setup(k,{emit:M}){const{showError:z}=X("alert"),p=q(k,"modelValue"),T=M,w=k;G(p,async e=>{e?(await L(),await V()):Z()});const c=v(!1),h=v(!1);let r,b;const x=v([]),m=v([]),u=v(-1);let l=null;const s=J({hasZoom:!1,maxZoom:10,minZoom:1,zoom:1,hasTorch:!1});let C={formats:["Code128"],maxNumberOfSymbols:1,tryRotate:!1,tryInvert:!1,tryHarder:!0,minLineCount:2,characterSet:"ASCII"};const t=K(null),O=e=>{p.value=!1,T("change",e.text)},E=async()=>{h.value=!0,F(),await I()},I=async()=>{try{if(h.value){const e=await $();e!=null&&e.length&&(w.isSelect?(H(),x.value=e):O(e[0])),requestAnimationFrame(I)}}catch(e){throw e}},F=()=>{var e,a;r&&r.width===((e=t.value)==null?void 0:e.videoWidth)&&r.height===((a=t.value)==null?void 0:a.videoHeight)||(r=new OffscreenCanvas(t.value.videoWidth,t.value.videoHeight),b=r.getContext("2d"))},$=async()=>{try{b.drawImage(t.value,0,0);const e=b.getImageData(0,0,r.width,r.height);return await te(e,C)}catch(e){z(e)}},L=async()=>{if(m.value.length)return;await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}});const e=await navigator.mediaDevices.enumerateDevices(),a=[];e.forEach(o=>{var n;o.getCapabilities&&(n=o.getCapabilities().facingMode)!=null&&n.includes("environment")&&a.push(o.deviceId)}),m.value=a},A=async()=>{m.value.length!==1&&(Z(),u.value>=m.value.length-1?u.value=0:u.value++,await V())},V=async()=>{var e,a;c.value=!1;try{u.value===-1&&(u.value=0);const o=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:m.value[u.value]}}});if(t.value.srcObject=o,t.value.play(),u.value=0,l=o.getVideoTracks()[0],l.getCapabilities&&l.getSettings){const n=l.getSettings(),d=l.getCapabilities();s.hasZoom=n.zoom!==void 0,s.maxZoom=((e=d.zoom)==null?void 0:e.max)||1,s.minZoom=((a=d.zoom)==null?void 0:a.min)||1,s.zoom=n.zoom||1,s.hasTorch=n.torch!==void 0}}catch(o){z(o)}},H=()=>{var e;(e=t.value)!=null&&e.srcObject&&(h.value=!1,t.value.pause()),c.value=!1},Z=()=>{var e;(e=t.value)!=null&&e.srcObject&&(h.value=!1,t.value.srcObject.getTracks().forEach(a=>a.stop()),t.value.srcObject=null),x.value=[],c.value=!1},N=()=>{c.value=!c.value,t.value.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:c.value}]})},U=e=>{s.hasZoom&&(l==null||l.applyConstraints({advanced:[{zoom:e}]}))};return P(()=>{w.options&&(C=Object.assign(C,w.options)),Q({locateFile:(e,a)=>e.endsWith(".wasm")?`/pwa/${e}`:a+e})}),(e,a)=>{const o=_("v-btn"),n=_("v-slider"),d=_("v-sheet");return g((S(),R(d,{class:"position-fixed top-0 bottom-0 ma-0 pa-0 w-100 h-100 bg-white",style:{"z-index":"2000"}},{default:B(()=>[D("video",{onLoadeddata:E,ref_key:"$video",ref:t,class:"position-fixed h-100 w-100"},null,544),D("div",ie,[(S(!0),Y(ae,null,ee(x.value,i=>(S(),R(o,{style:oe({left:(i.position.topLeft.x+i.position.bottomRight.x)/2+"px",top:(i.position.topLeft.y+i.position.bottomRight.y)/2+"px"}),class:"position-absolute",key:i.symbologyIdentifier,icon:"far fa-circle-right",color:"success",onClick:ne=>O(i)},null,8,["style","onClick"]))),128))]),f(d,{class:"d-flex w-100 ga-2 position-absolute bottom-0 pa-4 bg-transparent"},{default:B(()=>[g(f(o,{onClick:N,icon:"fas fa-bolt",size:"small",color:c.value?"success":""},null,8,["color"]),[[y,s.hasTorch]]),g(f(o,{onClick:A,icon:"fas fa-rotate",size:"small"},null,512),[[y,m.value.length>1]]),f(o,{onClick:a[0]||(a[0]=i=>p.value=!1),size:"small",icon:"fas fa-xmark"}),g(f(n,{class:"flex-1-0",color:"white","hide-details":"",size:"small","onUpdate:modelValue":[U,a[1]||(a[1]=i=>s.zoom=i)],modelValue:s.zoom,min:s.minZoom,max:s.maxZoom,step:1},null,8,["modelValue","min","max"]),[[y,s.hasZoom]])]),_:1})]),_:1},512)),[[y,p.value]])}}}),ue=se(le,[["__scopeId","data-v-ec6513d4"]]);export{ue as S};
