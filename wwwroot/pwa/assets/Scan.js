import{d as U,m as Z,u as q,w as G,s as m,t as J,A as K,B as P,C as Q,n as p,v as h,c as j,b as R,i as X,r as x,o as C,k as B,h as Y,l as ee,F as ae,e as v,E as te,D as oe}from"./vendor.js";import{_ as se}from"./KVUpload.js";const le={class:"position-fixed h-100 w-100"},ne=U({__name:"Scan",props:Z({isSelect:{type:Boolean,default:!1},options:{type:Object}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:Z(["change"],["update:modelValue"]),setup(_,{emit:T}){const{showError:S}=X("alert"),d=q(_,"modelValue"),D=T,g=_;G(d,async e=>{e?(await L(),await O()):I()});const n=m(!1),f=m(!1);let i,y;const w=m([]),u=m([]),c=m(-1);let l=null;const o=J({hasZoom:!1,maxZoom:10,minZoom:1,zoom:1,hasTorch:!1});let b={formats:["Code128"],maxNumberOfSymbols:1,tryRotate:!1,tryInvert:!1,tryHarder:!0,minLineCount:2,characterSet:"ASCII"};const t=K(null),k=e=>{d.value=!1,D("change",e.text)},F=async()=>{f.value=!0,$(),await z()},z=async()=>{try{if(f.value){const e=await E();e!=null&&e.length&&(g.isSelect?(A(),w.value=e):k(e[0])),requestAnimationFrame(z)}}catch(e){throw e}},$=()=>{var e,a;i&&i.width===((e=t.value)==null?void 0:e.videoWidth)&&i.height===((a=t.value)==null?void 0:a.videoHeight)||(i=new OffscreenCanvas(t.value.videoWidth,t.value.videoHeight),y=i.getContext("2d"))},E=async()=>{try{y.drawImage(t.value,0,0);const e=y.getImageData(0,0,i.width,i.height);return await te(e,b)}catch(e){S(e)}},L=async()=>{if(u.value.length)return;const e=await navigator.mediaDevices.enumerateDevices();u.value=e==null?void 0:e.map(a=>a.deviceId)},M=async()=>{u.value.length!==1&&(I(),c.value>=u.value.length-1?c.value=0:c.value++,await O())},O=async()=>{n.value=!1;try{c.value===-1&&(c.value=0);const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:u.value[c.value]}}});if(t.value.srcObject=e,t.value.play(),c.value=0,l=e.getVideoTracks()[0],l.getCapabilities&&l.getSettings){const a=l.getSettings(),r=l.getCapabilities();o.hasZoom=a.zoom!==void 0,o.maxZoom=r.zoom.max,o.minZoom=r.zoom.min,o.zoom=a.zoom,o.hasTorch=a.torch!==void 0}}catch(e){S(e)}},A=()=>{var e;(e=t.value)!=null&&e.srcObject&&(f.value=!1,t.value.pause()),n.value=!1},I=()=>{var e;(e=t.value)!=null&&e.srcObject&&(f.value=!1,t.value.srcObject.getTracks().forEach(a=>a.stop()),t.value.srcObject=null),w.value=[],n.value=!1},H=()=>{n.value=!n.value,t.value.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:n.value}]})},N=e=>{o.hasZoom&&(l==null||l.applyConstraints({advanced:[{zoom:e}]}))};return P(()=>{g.options&&(b=Object.assign(b,g.options)),Q({locateFile:(e,a)=>e.endsWith(".wasm")?`/pwa/${e}`:a+e})}),(e,a)=>{const r=x("v-btn"),W=x("v-slider"),V=x("v-sheet");return p((C(),j(V,{class:"position-fixed top-0 bottom-0 ma-0 pa-0 w-100 h-100 bg-white",style:{"z-index":"2000"}},{default:R(()=>[B("video",{onLoadeddata:F,ref_key:"$video",ref:t,class:"position-fixed h-100 w-100"},null,544),B("div",le,[(C(!0),Y(ae,null,ee(w.value,s=>(C(),j(r,{style:oe({left:(s.position.topLeft.x+s.position.bottomRight.x)/2+"px",top:(s.position.topLeft.y+s.position.bottomRight.y)/2+"px"}),class:"position-absolute",key:s.symbologyIdentifier,icon:"far fa-circle-right",color:"success",onClick:ie=>k(s)},null,8,["style","onClick"]))),128))]),v(V,{class:"d-flex w-100 ga-2 position-absolute bottom-0 pa-4 bg-transparent"},{default:R(()=>[p(v(r,{onClick:H,icon:"fas fa-bolt",size:"small",color:n.value?"success":""},null,8,["color"]),[[h,o.hasTorch]]),p(v(r,{onClick:M,icon:"fas fa-rotate",size:"small"},null,512),[[h,u.value.length>1]]),v(r,{onClick:a[0]||(a[0]=s=>d.value=!1),size:"small",icon:"fas fa-xmark"}),p(v(W,{class:"flex-1-0",color:"white","hide-details":"",size:"small","onUpdate:modelValue":[N,a[1]||(a[1]=s=>o.zoom=s)],modelValue:o.zoom,min:o.minZoom,max:o.maxZoom,step:1},null,8,["modelValue","min","max"]),[[h,o.hasZoom]])]),_:1})]),_:1},512)),[[h,d.value]])}}}),ue=se(ne,[["__scopeId","data-v-96bfb94c"]]);export{ue as S};
