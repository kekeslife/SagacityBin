import{d as W,m as M,u as q,w as G,s as d,t as J,A as K,B as P,C as Q,n as h,v as w,c as j,b as D,i as X,r as _,o as S,k as R,h as Y,l as ee,F as ae,e as f,E as te,D as oe}from"./vendor.js";import{_ as se}from"./KVUpload.js";const ie={class:"position-fixed h-100 w-100"},le=W({__name:"Scan",props:M({isSelect:{type:Boolean,default:!1},options:{type:Object}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:M(["change"],["update:modelValue"]),setup(k,{emit:B}){const{showError:z}=X("alert"),p=q(k,"modelValue"),T=B,y=k;G(p,async e=>{e?(await L(),await V()):Z()});const c=d(!1),g=d(!1);let r,b;const x=d([]),u=d([]),m=d(-1);let l=null;const s=J({hasZoom:!1,maxZoom:10,minZoom:1,zoom:1,hasTorch:!1});let C={formats:["Code128"],maxNumberOfSymbols:1,tryRotate:!1,tryInvert:!1,tryHarder:!0,minLineCount:2,characterSet:"ASCII"};const o=K(null),O=e=>{p.value=!1,T("change",e.text)},E=async()=>{g.value=!0,F(),await I()},I=async()=>{try{if(g.value){const e=await $();e!=null&&e.length&&(y.isSelect?(U(),x.value=e):O(e[0])),requestAnimationFrame(I)}}catch(e){throw e}},F=()=>{var e,a;r&&r.width===((e=o.value)==null?void 0:e.videoWidth)&&r.height===((a=o.value)==null?void 0:a.videoHeight)||(r=new OffscreenCanvas(o.value.videoWidth,o.value.videoHeight),b=r.getContext("2d"))},$=async()=>{try{b.drawImage(o.value,0,0);const e=b.getImageData(0,0,r.width,r.height);return await te(e,C)}catch(e){z(e)}},L=async()=>{if(u.value.length)return;await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}});const e=await navigator.mediaDevices.enumerateDevices(),a=[];e.forEach(t=>{var n;t.getCapabilities&&(n=t.getCapabilities().facingMode)!=null&&n.includes("environment")&&a.push(t.deviceId)}),u.value=a},A=async()=>{u.value.length!==1&&(Z(),m.value>=u.value.length-1?m.value=0:m.value++,await V())},V=async()=>{var e,a;c.value=!1;try{m.value===-1&&(m.value=0);let t;if(u.value.length?t=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:u.value[m.value]}}}):t=await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"environment"}}),o.value.srcObject=t,o.value.play(),m.value=0,l=t.getVideoTracks()[0],l.getCapabilities&&l.getSettings){const n=l.getSettings(),v=l.getCapabilities();s.hasZoom=n.zoom!==void 0,s.maxZoom=((e=v.zoom)==null?void 0:e.max)||1,s.minZoom=((a=v.zoom)==null?void 0:a.min)||1,s.zoom=n.zoom||1,s.hasTorch=n.torch!==void 0}}catch(t){z(t)}},U=()=>{var e;(e=o.value)!=null&&e.srcObject&&(g.value=!1,o.value.pause()),c.value=!1},Z=()=>{var e;(e=o.value)!=null&&e.srcObject&&(g.value=!1,o.value.srcObject.getTracks().forEach(a=>a.stop()),o.value.srcObject=null),x.value=[],c.value=!1},H=()=>{c.value=!c.value,o.value.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:c.value}]})},N=e=>{s.hasZoom&&(l==null||l.applyConstraints({advanced:[{zoom:e}]}))};return P(()=>{y.options&&(C=Object.assign(C,y.options)),Q({locateFile:(e,a)=>e.endsWith(".wasm")?`/pwa/${e}`:a+e})}),(e,a)=>{const t=_("v-btn"),n=_("v-slider"),v=_("v-sheet");return h((S(),j(v,{class:"position-fixed top-0 bottom-0 ma-0 pa-0 w-100 h-100 bg-white",style:{"z-index":"2000"}},{default:D(()=>[R("video",{onLoadeddata:E,ref_key:"$video",ref:o,class:"position-fixed h-100 w-100"},null,544),R("div",ie,[(S(!0),Y(ae,null,ee(x.value,i=>(S(),j(t,{style:oe({left:(i.position.topLeft.x+i.position.bottomRight.x)/2+"px",top:(i.position.topLeft.y+i.position.bottomRight.y)/2+"px"}),class:"position-absolute",key:i.symbologyIdentifier,icon:"far fa-circle-right",color:"success",onClick:ne=>O(i)},null,8,["style","onClick"]))),128))]),f(v,{class:"d-flex w-100 ga-2 position-absolute bottom-0 pa-4 bg-transparent"},{default:D(()=>[h(f(t,{onClick:H,icon:"fas fa-bolt",size:"small",color:c.value?"success":""},null,8,["color"]),[[w,s.hasTorch]]),h(f(t,{onClick:A,icon:"fas fa-rotate",size:"small"},null,512),[[w,u.value.length>1]]),f(t,{onClick:a[0]||(a[0]=i=>p.value=!1),size:"small",icon:"fas fa-xmark"}),h(f(n,{class:"flex-1-0",color:"white","hide-details":"",size:"small","onUpdate:modelValue":[N,a[1]||(a[1]=i=>s.zoom=i)],modelValue:s.zoom,min:s.minZoom,max:s.maxZoom,step:1},null,8,["modelValue","min","max"]),[[w,s.hasZoom]])]),_:1})]),_:1},512)),[[w,p.value]])}}}),ue=se(le,[["__scopeId","data-v-f70fb980"]]);export{ue as S};
