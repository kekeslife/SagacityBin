import{d as N,s as c,A as h,h as j,e as d,b as k,q as D,F as E,i as v,r as V,o as L}from"../vendor.js";import{K as A}from"../KVUpload.js";import{S as B}from"../Scan.js";import{$ as _}from"../axiosExt.js";import{v as p}from"../lang.js";import"../pinia.js";import"../storage.js";import"../json-data.js";const G=N({__name:"UploadPic",setup(F){const{showError:s}=v("alert"),{lang:n}=v("lang"),g=v("loading"),l=c(null);let f="";const S=c(""),r=h([]),m=c(!1);let i=!1;const w={sn:[a=>a?(C(a),!0):n.value.validate.不能为空]},U=async()=>l.value?f!==l.value?(s(p.属性已变更(n.value.validate,"sn")),!1):!0:(s(p.属性不能为空(n.value.validate,"sn")),!1),b=async()=>l.value?f!==l.value?(s(p.属性已变更(n.value.validate,"sn")),!1):!0:(s(p.属性不能为空(n.value.validate,"sn")),!1),P=(a,e)=>{a.fileName=e.record,i||(i=!0,y())},$=(a,e)=>{i||(i=!0,y())},y=async()=>{if(l.value)try{const e=(await _.post("/api/fieldPic/log",l.value,{headers:{"Content-Type":"application/json"}})).data;if(!e.isSuccess)throw e.message}catch(a){s(a)}},C=a=>{a&&(l.value=a,x(a))},x=async a=>{g.value=!0;try{const o=(await _.post("/api/fieldPic/pics/",a,{headers:{"Content-Type":"application/json"}})).data;if(o.isSuccess)S.value=o.message,f=a,o.records?r.value=o.records.map(u=>({fileName:u,src:`/files/field/${o.message}/${u}`,state:"success"})):r.value=[];else throw o.message}catch(e){s(e)}finally{g.value=!1}};return(a,e)=>{const o=V("v-text-field"),u=V("v-form");return L(),j(E,null,[d(u,{onSubmit:e[2]||(e[2]=D(()=>{},["prevent"])),"validate-on":"submit",class:"ma-4"},{default:k(()=>[d(o,{clearable:!0,label:"SN",modelValue:l.value,"onUpdate:modelValue":e[0]||(e[0]=t=>l.value=t),color:"primary","base-color":"primary","append-icon":"fas fa-barcode",rules:w.sn,"onClick:append":e[1]||(e[1]=t=>m.value=!0)},null,8,["modelValue","rules"])]),_:1}),d(B,{options:{formats:["EAN-13","QRCode","Code128","Code39"]},modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=t=>m.value=t),onChange:C},null,8,["modelValue"]),d(A,{"up-url":"/api/fieldPic/upload","del-url":"/api/fieldPic/del","del-data":t=>`${S.value}/${t.fileName}`,"up-data":t=>({sn:l.value}),"pre-upload":U,"pre-delete":b,onPostUpload:P,onPostDelete:$,modelValue:r.value,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value=t)},null,8,["del-data","up-data","modelValue"])],64)}}});export{G as default};
