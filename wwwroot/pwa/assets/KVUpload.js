import{d as O,m as I,u as P,s as y,h as V,e as s,b as n,F,i as S,r as u,o as D,j as k,V as C,k as R,l as G,n as $,v as j,c as H,p as J,q as Q,t as W,x as X}from"./vendor.js";import{$ as B}from"./axiosExt.js";const Y=["multiple"],Z={class:"w-100 h-100"},ee=O({__name:"KVUpload",props:I({upData:{type:Function},delData:{type:Function},preUpload:{type:Function},preDelete:{type:Function},upUrl:{type:String,required:!0},delUrl:{type:String,required:!0},multiple:{type:Boolean,default:!1}},{modelValue:{required:!0},modelModifiers:{}}),emits:I(["postUpload","postDelete"],["update:modelValue"]),setup(f,{emit:g}){const{showConfirm:_}=S("alert"),{lang:h}=S("lang"),i=P(f,"modelValue"),l=f,b=g,w=y(!1),x=y(""),m=y(null),M=async()=>{var t,r;if(((r=(t=m.value)==null?void 0:t.files)==null?void 0:r.length)!==0&&!(l.preUpload&&!await l.preUpload(m.value.files)))for(const c of m.value.files){const o=new FileReader;o.readAsDataURL(c),o.onload=a=>{var v;const e={src:(v=a.target)==null?void 0:v.result,state:"uploading",fileName:c.name},p=i.value.unshift(e);q(c,p)}}},q=async(t,r)=>{const c=new FormData;c.append("file",t);const o=i.value[Math.max(0,i.value.length-r)];if(l.upData){const a=l.upData(o);for(const e in a)c.append(e,a[e])}try{const e=(await B.post(l.upUrl,c)).data;if(e.isSuccess)i.value[0].state="success",b("postUpload",o,e);else throw e.message}catch{o.state="error"}},z=()=>{var t;(t=m.value)==null||t.click()},N=()=>{w.value=!1},K=t=>{x.value=t.src,w.value=!0},L=async t=>{const r=i.value[t];if(l.preDelete&&!await l.preDelete(r))return;if(!await new Promise((a,e)=>{_(h.value.util.确认删除,a)}))return!1;r.state="uploading";let o={};l.delData&&(o=l.delData(r));try{const e=(await B.post(l.delUrl,o,{headers:{"Content-Type":"application/json"}})).data;if(e.isSuccess){const p=i.value.splice(t,1);b("postDelete",p[0],e)}else throw e.message}catch{r.state="error"}};return(t,r)=>{const c=u("v-icon"),o=u("v-btn"),a=u("v-col"),e=u("v-progress-circular"),p=u("v-sheet"),v=u("v-row"),A=u("v-container"),T=u("v-fade-transition");return D(),V(F,null,[s(A,null,{default:n(()=>[s(v,null,{default:n(()=>[s(a,{cols:"4",sm:"3",md:"2",lg:"1"},{default:n(()=>[s(k(C),{"aspect-ratio":1,cover:"",class:"bg-grey-lighten-3"},{default:n(()=>[s(o,{onClick:z,class:"w-100 h-100 rounded-0",variant:"text"},{default:n(()=>[s(c,{size:"x-large",icon:"fas fa-plus"}),R("input",{ref_key:"$file",ref:m,onChange:M,multiple:l.multiple,type:"file",accept:"image/*",style:{display:"none"}},null,40,Y)]),_:1})]),_:1})]),_:1}),(D(!0),V(F,null,G(i.value,(d,U)=>(D(),H(a,{key:U,class:"position-relative overflow-hidden",cols:"4",sm:"3",md:"2",lg:"1"},{default:n(()=>[s(k(C),{class:J(["border border-lg border-surface-light border-opacity-50",{"border-error":d.state==="error","border-success":d.state==="success"}]),"aspect-ratio":1,src:d.src,cover:"",onClick:E=>K(d)},{default:n(()=>[s(o,{size:"x-small",ripple:!1,class:"position-absolute pa-0 remove",variant:"tonal",icon:"fas fa-xmark",onClick:Q(E=>L(U),["stop"])},null,8,["onClick"]),$(R("div",Z,[s(p,{class:"img-loading d-flex position-absolute top-0 bottom-0 w-100 h-100 align-center justify-center"},{default:n(()=>[s(e,{color:"primary",indeterminate:""},{default:n(()=>[W(X(d.state),1)]),_:2},1024)]),_:2},1024)],512),[[j,d.state==="uploading"]])]),_:2},1032,["class","src","onClick"])]),_:2},1024))),128))]),_:1})]),_:1}),s(T,null,{default:n(()=>[$(s(p,{class:"position-fixed top-0 bottom-0 bg-white",style:{height:"100vh",width:"100vw","z-index":"2000"},onClick:N},{default:n(()=>[s(k(C),{class:"w-100 h-100",src:x.value},null,8,["src"])]),_:1},512),[[j,w.value]])]),_:1})],64)}}}),te=(f,g)=>{const _=f.__vccOpts||f;for(const[h,i]of g)_[h]=i;return _},oe=te(ee,[["__scopeId","data-v-c19ad7c0"]]);export{oe as K,te as _};
